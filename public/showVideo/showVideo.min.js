var showVideo={oVideoOption:{url:"http://www.showplusplus.cn:9000/showServer",unit:100/24/60,nType:1,token:"",isJson:!1,successCode:0,sPlayOption:"ws-flv",tokenName:"token",sPlayUrl:"/play/manage/getPlayMsg.json",sPlayBackUrl:"/play/manage/getReplayPlayMsg.do",sControllerUrl:"/play/manage/playController.do",sMonthFileListUrl:"/play/manage/queryVideoTimeInMonth.do",sMonthFileStartTime:"startTime",sDayFileListUrl:"/play/manage/queryVideoTimeInDay.do",sReplayControl:"",streamKind:"streamKind",step:"step",ptzCommand:"ptzCommand",stop:"stop",endTime:"endTime",queryEndTime:"endTime",oQueryFileList:{},aStreamKind:[{name:"主",value:0},{name:"子",value:1}]},parseTimeToString:function(o,i){if(0===arguments.length)return null;var e,t=i||"{y}-{m}-{d} {h}:{i}:{s}";"object"==typeof o?e=o:("string"==typeof o&&/^[0-9]+$/.test(o)&&(o=parseInt(o)),"number"==typeof o&&10===o.toString().length&&(o*=1e3),e=new Date(o));var n={y:e.getFullYear(),m:e.getMonth()+1,d:e.getDate(),h:e.getHours(),i:e.getMinutes(),s:e.getSeconds(),a:e.getDay()},a=t.replace(/{([ymdhisa])+}/g,function(o,i){var e=n[i];return"a"===i?["日","一","二","三","四","五","六"][e]:e.toString().padStart(2,"0")});return a},decimalsToFractional:function(o){function i(){a=t>n?t:n;for(var o=a;o>1;o--)Number.isInteger(n/o)&&Number.isInteger(t/o)&&(n/=o,t/=o,i())}if(o>=1)return o;var e=o.toFixed(5),t=1e4,n=1e4*e,a=0;return i(),n+"/"+t},setVideoOption:function(o){if(o&&"[object Object]"===Object.prototype.toString.call(o))for(var i in o.type&&(o.nType=o.type),o.nType&&(1===o.nType||(2===o.nType?(this.oVideoOption.sPlayUrl="/admin/deviceChannel/getRealPlayUrl",this.oVideoOption.sPlayBackUrl="/admin/deviceChannel/getReplayUrl",this.oVideoOption.sControllerUrl="/admin/deviceChannel/ptzControl",this.oVideoOption.sMonthFileListUrl="",this.oVideoOption.sDayFileListUrl="/admin/deviceChannel/queryRecordFileList",this.oVideoOption.sReplayControl="/admin/deviceChannel/replayControl",this.oVideoOption.streamKind="streamCode",this.oVideoOption.step="ptzStep",this.oVideoOption.stop="isStop",this.oVideoOption.endTime="stopTime",this.oVideoOption.aStreamKind=[{name:"主",value:0},{name:"子",value:1},{name:"压缩",value:2,filter:"compress"}]):3===o.nType?(this.oVideoOption.isJson=!0,this.oVideoOption.successCode=1,this.oVideoOption.sReplayControl="/manageserver/playbackcontrol",this.oVideoOption.sPlayUrl="/manageserver/getrealplayurl",this.oVideoOption.sPlayBackUrl="/manageserver/getplaybackurl",this.oVideoOption.sControllerUrl="/manageserver/ptzcontrol",this.oVideoOption.sMonthFileListUrl="",this.oVideoOption.sDayFileListUrl="/manageserver/queryrecordfilelist",this.oVideoOption.streamKind="streamCode",this.oVideoOption.step="ptzStep",this.oVideoOption.stop="isStop",this.oVideoOption.endTime="stopTime",this.oVideoOption.queryEndTime="stopTime",this.oVideoOption.oQueryFileList={fileKind:2,fileLocation:2},this.oVideoOption.aStreamKind=[{name:"主",value:0},{name:"子",value:1},{name:"压缩",value:2,filter:"compress"}]):4===o.nType?(this.oVideoOption.sReplayControl="/admin/camera/replayControl",this.oVideoOption.sPlayUrl="/admin/camera/getRealPlayUrl",this.oVideoOption.sPlayBackUrl="/admin/camera/getPlayBackUrl",this.oVideoOption.sControllerUrl="/admin/camera/ptzControl",this.oVideoOption.sMonthFileListUrl="/admin/camera/getRecordFileInMonth",this.oVideoOption.sMonthFileStartTime="month",this.oVideoOption.sDayFileListUrl="/admin/camera/queryRecordFileList",this.oVideoOption.streamKind="streamCode",this.oVideoOption.step="ptzStep",this.oVideoOption.stop="isStop",this.oVideoOption.endTime="stopTime",this.oVideoOption.aStreamKind=[{name:"主",value:0},{name:"子",value:1}]):5===o.nType&&(this.oVideoOption.tokenName="accessToken",this.oVideoOption.sPlayBackUrl="/api/record/getReplayUrl",this.oVideoOption.sMonthFileListUrl="",this.oVideoOption.sDayFileListUrl="/api/record/list",this.oVideoOption.sPlayOption="flvUrl"))),o)this.oVideoOption[i]=o[i]},playController:function(o,i,e){this.ajax({type:"POST",url:this.oVideoOption.url+this.oVideoOption.sControllerUrl,data:o,complete:function(o){e&&e();var t={code:"-1",msg:"请求失败"};200===o.status&&(t=o.responseJSON),i.fPlayController(t)}})},replayControl:function(o,i,e){o.uuid&&this.oVideoOption.sReplayControl&&this.ajax({type:"POST",url:this.oVideoOption.url+this.oVideoOption.sReplayControl,data:o,complete:function(o){e&&e(o);var t={code:"-1",msg:"请求失败"};200===o.status&&(t=o.responseJSON),i.fReplayControl(t)}})},createYunDiv:function(o,i,e){if($("#"+o).is(".has-control")){var t=$("#video-top-yun"),n=$("#"+o+" #video-top-yun");n[0]&&!0!==e?t.remove():(t[0]?t.remove():t=$('<div id="video-top-yun" class="video-control"><i class="el-icon-close video-control-close" ptzCommand="98" /></i><div class="video-control-cloud"><div class="video-control-yuan"><i class="el-icon-arrow-left" ptzCommand="3"></i><i class="el-icon-arrow-up" ptzCommand="1"></i><i class="el-icon-arrow-right" ptzCommand="4"></i><i class="el-icon-arrow-down" ptzCommand="2"></i></div><ul class="video-control-ul"><li class="video-control-input"><span>速度</span><input id="video-control-step" type="number" size="mini" max="10" min="1"" value="5"/></li><li><i class="el-icon-circle-plus-outline" ptzCommand="10"></i><span>变倍</span><i class="el-icon-remove-outline" ptzCommand="11"></i></li><li><i class="el-icon-circle-plus-outline" ptzCommand="12"></i><span>调焦</span><i class="el-icon-remove-outline" ptzCommand="13"></i></li><li><i class="el-icon-circle-plus-outline" ptzCommand="14"></i><span>光圈</span><i class="el-icon-remove-outline" ptzCommand="15"></i></li></ul></div></div>'),$("#"+o+" .el-icon-full-screen").is(".el-open")&&t.css({right:"10px",bottom:"0",top:"0",margin:"auto 0"}),i.append(t))}},fullScreen:function(o,i,e,t){if(o.is(".el-open"))o.removeClass("el-open"),$("#video-top-yun").remove(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else if(!t){o.addClass("el-open");var n=i[0];showVideo.createYunDiv(e,i,!0),n.requestFullscreen?n.requestFullscreen():n.msRequestFullscreen?n.msRequestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullscreen&&n.webkitRequestFullscreen(),window.onresize=function(){var i=!!(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement);i||(o.removeClass("el-open"),$("#video-top-yun").remove())}}},saveScreenshot:function(o){var i=$("#"+o+"-video canvas").get(0);if(i){n=i.toDataURL();if(n.length<786432)return setTimeout(function(){showVideo.saveScreenshot(o)},40)}else{var e=$("#"+o+"-video video").get(0),t=1;i=document.createElement("canvas"),i.width=e.videoWidth*t,i.height=e.videoHeight*t,i.getContext("2d").drawImage(e,0,0,i.width,i.height);var n=i.toDataURL();if(-1===n.indexOf("base64"))return void alert("暂无画面")}var a=document.createEvent("HTMLEvents");a.initEvent("click",!0,!0);var s=document.createElement("a");s.download=(new Date).getTime()+".png",s.href=n,s.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))},createVideo:function(o,i){var e;if("[object Object]"===Object.prototype.toString.call(o)&&(this.option=o,o.id)){e=$("#"+o.id);var t=this,n={position:"relative",boxSizing:"border-box"},a="";if(this.option.playBack)n.paddingBottom="60px",a='<div style="width: 100%;height: 100%;position: relative"><i class="video-close" ptzCommand="99"/></i><div class="video-tips"></div><easy-player id="'+o.id+'-video" live="true" stretch="true" alt="未加载视频"></easy-player><div class="video-control video-control-small"><div class="video-control-kind"><span class="replay-control"><i>当前倍数：<b class="replay-control-multiple">1</b>倍</i><i controlKind="6">1.0</i><i controlKind="4">X2</i><i controlKind="5">/2</i></span><i ptzCommand="91">抓</i><i style="font-size: 16px;" class="el-icon-full-screen" ptzCommand="92" /></div></div></div>',showVideo.oVideoOption.sReplayControl?e.addClass("has-replay-control"):e.removeClass("has-replay-control");else{n.paddingBottom="0",a='<div style="width: 100%;height: 100%;position: relative"><i class="video-close" ptzCommand="99"/></i><div class="video-tips"></div><easy-player id="'+o.id+'-video" live="true" stretch="true" alt="未加载视频"></easy-player><div class="video-control video-control-small"><div class="video-control-kind">';for(var s=showVideo.oVideoOption.aStreamKind,d=0;d<s.length;d++)s[d].filter&&!o[s[d].filter]||(a+='<i class="video-control-play" ptzCommand="'+s[d].value+'">'+s[d].name+"</i>");this.option.control?e.addClass("has-control"):e.removeClass("has-control"),a+='<i class="video-control-yun" ptzCommand="93">云台</i><i ptzCommand="91">抓</i><i style="font-size: 16px;" class="el-icon-full-screen" ptzCommand="92" /></div></div></div>'}e.off(),e.css(n).on("dblclick",function(i){if($(i.target).is("#"+o.id+"-video")){var t=$("#"+o.id+" .el-icon-full-screen");showVideo.fullScreen(t,e,o.id)}}).on("mousedown",function(i){var n=$(i.target);if(n.is("i")){var a=n.attr("ptzCommand"),s=n.attr("controlKind");if(a||0==a)if(92==a)showVideo.fullScreen(n,e,o.id);else if(93==a)showVideo.createYunDiv(o.id,e);else if(98==a)$("#video-top-yun").remove();else if(99==a)t.dispose(),showVideo.fullScreen($("#"+o.id+" .el-icon-full-screen"),e,o.id,!0);else if(n.is('[class^="el-icon"]')){n.addClass("hover");var d=$("#video-control-step").val();if(t.bController||t.bStopController)return;t.bController=!0;var l={};for(var r in l[showVideo.oVideoOption.tokenName]=showVideo.oVideoOption.token,l[showVideo.oVideoOption.step]=d||5,l[showVideo.oVideoOption.ptzCommand]=a,l[showVideo.oVideoOption.stop]=0,o.data)"streamKind"!==r&&(l[r]=o.data[r]);showVideo.playController(l,t,function(){t.bController=!1})}else 91==a?showVideo.saveScreenshot(o.id):n.is(".video-control-play")&&(n.addClass("hover").siblings().removeClass("hover"),t.option.data.streamKind=a,t.playVideo());else if(s||0==s){l={progressCode:0,controlFlag:0,controlKind:s};for(var r in o.data)"streamKind"!==r&&(l[r]=o.data[r]);if(l[showVideo.oVideoOption.tokenName]=showVideo.oVideoOption.token,5==s&&.125===t.multiple)return;if(4==s&&8===t.multiple)return;if(6==s&&1===t.multiple)return;4==s?t.multiple*=2:5==s?t.multiple/=2:6==s&&(t.multiple=1),$("#"+t.option.id+" .replay-control-multiple").html(showVideo.decimalsToFractional(t.multiple)),showVideo.replayControl(l,t,function(o){200===o.status&&o.responseJSON&&(o.responseJSON.code,showVideo.oVideoOption.successCode)})}}}).on("mouseup",function(i){var e=$(i.target);if(e.is("i")){var n=e.attr("ptzCommand");if((n||0==n)&&e.is('[class^="el-icon"]')&&92!=n){e.removeClass("hover");var a=$("#video-control-step").val()||5;if(t.bStopController)return;t.bStopController=!0;var s={};for(var d in s[showVideo.oVideoOption.tokenName]=showVideo.oVideoOption.token,s[showVideo.oVideoOption.step]=a||5,s[showVideo.oVideoOption.ptzCommand]=n,s[showVideo.oVideoOption.stop]=1,o.data)"streamKind"!==d&&(s[d]=o.data[d]);if(t.bController)var l=setInterval(function(){t.bController||(clearInterval(l),l=null,showVideo.playController(s,t,function(){t.bStopController=!1}))},100);else showVideo.playController(s,t,function(){t.bStopController=!1})}}}),e.html(a),i&&i()}},ajax:function(o){return this.oVideoOption.isJson&&(o.data=JSON.stringify(o.data)),$.ajax(o)}};showVideo.createVideo.prototype.setVideoData=function(o,i){if("[object Object]"===Object.prototype.toString.call(o)){o.streamKind||0===o.streamKind||(o.streamKind=1),this.option.data=o;var e=i||{};this.fPlayFun=e.fPlayFun||function(){},this.fPlayController=e.fPlayController||function(){},this.fReplayControl=e.fReplayControl||function(){};var t=showVideo.oVideoOption.url;if(t){var n=this;if(n.nPlayCount=1,$("#"+this.option.id+" .video-control-play").eq(this.option.data.streamKind).addClass("hover").siblings().removeClass("hover"),$("#"+this.option.id+" .video-control").css("display","block"),$("#"+this.option.id+" .video-close").css("display","block"),this.option.playBack){var a=!!$("."+this.option.id+"-stamp")[0],s=null;s=a?$("#"+this.option.id+"-stamp-picker"):$('<input id="'+this.option.id+'-stamp-picker" readonly style="height:28px;line-height:28px">'),s.val(showVideo.parseTimeToString(new Date,"{y}-{m}-{d}")),a?s.datetimepicker("remove").off():$('<div class="'+this.option.id+'-stamp" style="padding: 4px;position: absolute;bottom: 0;width: 100%;box-sizing: border-box;"><div class="time-stamp-btn"><div class="time-stamp-option" id="'+this.option.id+'-stamp-option"></div><div class="time-stamp-index"  id="'+this.option.id+'-stamp-index"><div class="index-bg"></div><div class="index-title">00:00</div></div></div><div class="time-stamp-bg"><div>00:00</div><div>01:00</div><div>02:00</div><div>03:00</div><div>04:00</div><div>05:00</div><div>06:00</div><div>07:00</div><div>08:00</div><div>09:00</div><div>10:00</div><div>11:00</div><div>12:00</div><div>13:00</div><div>14:00</div><div>15:00</div><div>16:00</div><div>17:00</div><div>18:00</div><div>19:00</div><div>20:00</div><div>21:00</div><div>22:00</div><div>23:00</div></div></div>').prepend(s).appendTo($("#"+this.option.id));var d=function(o,i){if(o||i){var e={};for(var a in e[showVideo.oVideoOption.tokenName]=showVideo.oVideoOption.token,n.option.data)"streamKind"!==a&&(e[a]=n.option.data[a]);e[showVideo.oVideoOption.sMonthFileStartTime]=o?showVideo.parseTimeToString(new Date(o.date),"{y}-{m}"):showVideo.parseTimeToString(new Date,"{y}-{m}"),showVideo.ajax({type:"POST",url:t+showVideo.oVideoOption.sMonthFileListUrl,data:e,success:function(e){var t=[];if(e.data){4!==showVideo.oVideoOption.nType&&e.data.sort(function(o,i){return o-i});for(var a=0;a<e.data.length;a++)4===showVideo.oVideoOption.nType?1===e.data[a]&&t.push({state:3,day:a+1}):t.push({state:3,day:e.data[a]})}i?(l(),s.datetimepicker({format:"yyyy-mm-dd",minView:"2",language:"zh-CN",dataType:2,oData:t||[],endDate:new Date,pickerPosition:"top-right",container:$("#"+n.option.id)}).on("changeMonth",function(o){d(o)}).on("prev:month",function(o){d(o)}).on("next:month",function(o){d(o)}).on("changeDay",function(o){(o.oTarget.is(".old")||o.oTarget.is(".new"))&&d(o),l(o.date)})):o.fFill(t)}})}},l=function(o){var i={};for(var e in i[showVideo.oVideoOption.tokenName]=showVideo.oVideoOption.token,showVideo.oVideoOption.oQueryFileList)i[e]=showVideo.oVideoOption.oQueryFileList[e];for(var e in n.option.data)"streamKind"!==e&&(i[e]=n.option.data[e]);var a=o||new Date,s=showVideo.parseTimeToString(a,"{y}-{m}-{d}");5===showVideo.oVideoOption.nType?i.recordDate=s:(i.startTime=s+" 00:00:00",i[showVideo.oVideoOption.queryEndTime]=s+" 23:59:59");var d=$("#"+n.option.id+"-stamp-option");o||(d.off("click"),d.on("click",function(o){if(!$(o.target).is(d)){var i=parseInt(d.css("width"))/980,e=.1*o.offsetX/i,t=$(o.target),a=new Date(t.attr("data-startTime")).getTime()+parseInt(e/showVideo.oVideoOption.unit*60*1e3);$("#"+n.option.id+"-stamp-index").css("left",(a-new Date(showVideo.parseTimeToString(t.attr("data-endTime"),"{y}-{m}-{d}")+" 00:00:00").getTime())/1e3/60*showVideo.oVideoOption.unit+"%").children(".index-title").html(showVideo.parseTimeToString(a,"{h}:{i}")),n.playReplayVideo({startTime:a},t.attr("data-startTime").split(" ")[0])}})),showVideo.ajax({type:"POST",url:t+showVideo.oVideoOption.sDayFileListUrl,data:i,success:function(o){401===o.code&&alert("token失效，需要重新登录，回放所有功能需要登录才可以使用");var e="",t={};if(o.code===showVideo.oVideoOption.successCode&&o.data){for(var a=new Date(i.startTime),l=0;l<o.data.length;l++){var r=o.data[l],p=r.startTime,c=r[showVideo.oVideoOption.endTime],m=new Date(p),h=new Date(c);e+='<div data-startTime="'+p+'" data-endTime="'+c+'" style="width: '+(h-m)/1e3/60*showVideo.oVideoOption.unit+"%;left: "+(m-a)/1e3/60*showVideo.oVideoOption.unit+'%"></div>'}t=o.data[0]||{}}$("#"+n.option.id+"-stamp-index").css("left",0).children(".index-title").html("00:00"),n.playReplayVideo(t,s),d.html(e)}})};showVideo.oVideoOption.sMonthFileListUrl?d("",!0):(l(),s.datetimepicker({format:"yyyy-mm-dd",minView:"2",language:"zh-CN",dataType:2,endDate:new Date,pickerPosition:"top-right",container:$("#"+n.option.id)}).on("changeDay",function(o){l(o.date)}))}else this.playVideo()}else console.log("配置ip地址")}else console.log("设置正确的参数")},showVideo.createVideo.prototype.playReplayVideo=function(o,i){if($("#"+this.option.id+" .replay-control").css("display","none"),$("#"+this.option.id+" .replay-control-multiple").html(1),o.startTime){var e=new Date(o.startTime).getTime(),t=new Date(i+" 00:00:00").getTime();e<t&&(e=t),this.option.data.startTime=showVideo.parseTimeToString(e),this.option.data[showVideo.oVideoOption.queryEndTime]=i+" 23:59:59",this.option.data.uuid="",this.nowData=new Date(e).getTime(),this.playVideo()}else this.video&&this.video.attr("video-url","")},showVideo.createVideo.prototype.playVideo=function(o){if(!o||!this.isAjax){this.isAjax&&!o&&this.isAjax.abort();var i=showVideo.oVideoOption.url;if(i){if(!this.option.playBack&&!this.option.playBackFile||!this.option.data.uuid){this.option.playBack||this.option.playBackFile&&this.option.data&&this.option.data.startTime&&this.option.data[showVideo.oVideoOption.endTime]?i+=showVideo.oVideoOption.sPlayBackUrl:i+=showVideo.oVideoOption.sPlayUrl;var e={};for(var t in e[showVideo.oVideoOption.tokenName]=showVideo.oVideoOption.token,this.option.data)"streamKind"!==t&&(e[t]=this.option.data[t]);e[showVideo.oVideoOption.streamKind]=this.option.data.streamKind,this.oPlayBackTimer&&(clearInterval(this.oPlayBackTimer),this.oPlayBackTimer=null),this.multiple=1;var n=this;this.isAjax=showVideo.ajax({type:"POST",url:i,data:e,success:function(o){if(o.code!==showVideo.oVideoOption.successCode)console.log(o.error||"视频播放失败"),$("#"+n.option.id+" .no-single").html(o.error||"视频播放失败");else{var i=o.data||o;n.nPlayCount=1,(n.option.playBack||n.option.playBackFile)&&(4===showVideo.oVideoOption.nType?(n.option.data.taskId=i.taskId,n.option.data.uuid=i.taskId):2===showVideo.oVideoOption.nType?(n.option.data.streamId=i.streamId,n.option.data.uuid=i.streamId):n.option.data.uuid=i.uuid);var e=n.option.sPlayOption||showVideo.oVideoOption.sPlayOption||"ws-flv";n.playVideoUrl(i[e])}},complete:function(o){var i={code:"-1",msg:"请求失败"};200===o.status&&(i=o.responseJSON),n.fPlayFun(i),n.isAjax=null}})}}else console.log("配置ip地址")}},showVideo.createVideo.prototype.playVideoUrl=function(o){if(o){if(3===showVideo.oVideoOption.nType){var i=o.split("/live/")[1],e=i&&i.split(".")[0]||"";this.option.data||(this.option.data={}),this.option.data.streamId=e,this.option.data.uuid=e}var t=this;this.video||(this.video=$("#"+this.option.id+"-video"),this.video.on("loadstart",function(o){console.log(o)}).on("log",function(o){console.log(o)}).on("ended",function(o){console.log(o),t.playVideo(!0)}).on("error",function(o){console.log(o),t.playVideo(!0)})),t.option.data&&t.option.data.uuid&&$("#"+this.option.id+" .replay-control").css("display","inline"),this.video.attr("video-url",o+"?"+parseInt(1e3*Math.random()))}},showVideo.createVideo.prototype.dispose=function(){$("#"+this.option.id+" .video-control").css("display","none"),$("#"+this.option.id+" .video-close").css("display","none"),$("#"+this.option.id+" ."+this.option.id+"-stamp").remove(),this.video&&(this.video.attr("video-url",""),this.video=null)};